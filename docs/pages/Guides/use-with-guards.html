<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Use with guards | @scitizen/nest-casl</title>
	<meta name="description" content="Documentation for @scitizen/nest-casl">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="../../assets/css/main.css">
	<link rel="stylesheet" href="../../assets/css/pages.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="../../assets/js/search.json" data-base="../..">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="../../index.html" class="title">@scitizen/nest-casl</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-externals" checked />
							<label class="tsd-widget" for="tsd-filter-externals">Externals</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="../../modules.html">Globals</a>
				</li>
				<li>
					<a href="getting-started.html">Guides</a>
				</li>
				<li>
					<a href="use-with-guards.html">Use with guards</a>
				</li>
			</ul>
			<h1>Use with guards</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<style>
.code-block {
	tab-size: 4;
}

details.code-block summary {
	cursor: pointer;
}
details.code-block summary::before {
	content: '';
	border: 0.5em solid transparent;
	height: 0;
	width: 0;
	display: inline-block;
	border-left-color: currentColor;
	float: left;
	margin-right: 0.5em
}
details.code-block[open] summary::before {
	border-left-color: transparent;
	border-top-color: currentColor;
	margin-top: 0.25em
}
</style><p>Most of the times, you want to execute some guards before checking CASL policies, to extract some user informations before generating its abilities.</p>
				<p>This page will show you the various way to do.</p>
				<p>Let&#39;s assume you have the following <a href="../../interfaces/CaslAbilityFactory.html"><code>CaslAbilityFactory</code></a>:</p>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/ability-factory.service.ts#L1-L17">./src/ability-factory.service.ts</a></p>
						<pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">AbilityBuilder</span><span style="color: #000000">, </span><span style="color: #001080">PureAbility</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@casl/ability&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Injectable</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">CaslAbilityFactory</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@scitizen/nest-casl&#039;</span><span style="color: #000000">;</span>

<span style="color: #000000">@</span><span style="color: #795E26">Injectable</span><span style="color: #000000">()</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">AbilityFactory</span><span style="color: #000000"> </span><span style="color: #0000FF">implements</span><span style="color: #000000"> </span><span style="color: #267F99">CaslAbilityFactory</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #008000">// Here, `request` is the express or fastify request. You might get infos from it.</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">createFromRequest</span><span style="color: #000000">( </span><span style="color: #001080">_request</span><span style="color: #000000">: </span><span style="color: #267F99">unknown</span><span style="color: #000000"> ): </span><span style="color: #267F99">PureAbility</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #0000FF">const</span><span style="color: #000000"> { </span><span style="color: #0070C1">user</span><span style="color: #000000"> } = ( </span><span style="color: #001080">_request</span><span style="color: #000000"> </span><span style="color: #AF00DB">as</span><span style="color: #000000"> </span><span style="color: #267F99">any</span><span style="color: #000000"> );</span>
<span style="color: #000000">		</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">abilityBuilder</span><span style="color: #000000"> = </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #795E26">AbilityBuilder</span><span style="color: #000000">( </span><span style="color: #001080">PureAbility</span><span style="color: #000000"> );</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">if</span><span style="color: #000000">( </span><span style="color: #001080">user</span><span style="color: #000000">?.</span><span style="color: #001080">role</span><span style="color: #000000"> === </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000"> ) {</span>
<span style="color: #000000">			</span><span style="color: #001080">abilityBuilder</span><span style="color: #000000">.</span><span style="color: #795E26">can</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> );</span>
<span style="color: #000000">		}</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #001080">abilityBuilder</span><span style="color: #000000">.</span><span style="color: #795E26">build</span><span style="color: #000000">();</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</div></p>
				<a href="#the-naïve-approach" id="the-naïve-approach" style="color: inherit; text-decoration: none;">
					<h1>The naïve approach</h1>
				</a>
				<blockquote>
					<p>This method is <strong>not recommanded</strong>. You might skip directly to the <a href="#the-recommended-approach">recommended approach</a></p>
				</blockquote>
				<a href="#without-any-more-dependencies" id="without-any-more-dependencies" style="color: inherit; text-decoration: none;">
					<h2>Without any more dependencies</h2>
				</a>
				<p>This method does not require any external dependency, and is as close to NestJS as possible.</p>
				<p><details class="code-block"><summary><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/naive.guard.ts#L1-L30">./src/guards/naive.guard.ts</a></p>
						</summary><pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">CanActivate</span><span style="color: #000000">, </span><span style="color: #001080">ExecutionContext</span><span style="color: #000000">, </span><span style="color: #001080">UnauthorizedException</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Request</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;express&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">NaiveGuard</span><span style="color: #000000"> </span><span style="color: #0000FF">implements</span><span style="color: #000000"> </span><span style="color: #267F99">CanActivate</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">canActivate</span><span style="color: #000000">( </span><span style="color: #001080">context</span><span style="color: #000000">: </span><span style="color: #267F99">ExecutionContext</span><span style="color: #000000"> ): </span><span style="color: #267F99">boolean</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">request</span><span style="color: #000000"> = </span><span style="color: #001080">context</span><span style="color: #000000">.</span><span style="color: #795E26">switchToHttp</span><span style="color: #000000">().</span><span style="color: #795E26">getRequest</span><span style="color: #000000">&lt;</span><span style="color: #267F99">Request</span><span style="color: #000000">&gt;();</span>
<span style="color: #000000">		</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">authorization</span><span style="color: #000000"> = </span><span style="color: #001080">request</span><span style="color: #000000">.</span><span style="color: #795E26">header</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000"> );</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">if</span><span style="color: #000000">( !</span><span style="color: #001080">authorization</span><span style="color: #000000"> ){</span>
<span style="color: #000000">			</span><span style="color: #008000">// **BEWARE**: if the guard returns `false`, Nest will throw a `ForbiddenException` which is semantically incorrect here.</span>
<span style="color: #000000">			</span><span style="color: #008000">// The user is not *missing the right to do*, it is *not authenticated at all*.</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #795E26">UnauthorizedException</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Missing authorization header&#039;</span><span style="color: #000000"> );</span>
<span style="color: #000000">		}</span>
<span style="color: #000000">		</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">user</span><span style="color: #000000"> = </span><span style="color: #0000FF">this</span><span style="color: #000000">.</span><span style="color: #795E26">_getUserFromAuthorization</span><span style="color: #000000">( </span><span style="color: #001080">authorization</span><span style="color: #000000"> );</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">if</span><span style="color: #000000">( !</span><span style="color: #001080">user</span><span style="color: #000000"> ){</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #0000FF">false</span><span style="color: #000000">;</span>
<span style="color: #000000">		}</span>
<span style="color: #000000">		( </span><span style="color: #001080">request</span><span style="color: #000000"> </span><span style="color: #AF00DB">as</span><span style="color: #000000"> </span><span style="color: #267F99">any</span><span style="color: #000000"> ).</span><span style="color: #001080">user</span><span style="color: #000000"> = </span><span style="color: #001080">user</span><span style="color: #000000">;</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000">;</span>
<span style="color: #000000">	}</span>

<span style="color: #000000">	</span><span style="color: #0000FF">private</span><span style="color: #000000"> </span><span style="color: #795E26">_getUserFromAuthorization</span><span style="color: #000000">( </span><span style="color: #001080">authorization</span><span style="color: #000000">?: </span><span style="color: #267F99">string</span><span style="color: #000000"> ){</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">if</span><span style="color: #000000">( </span><span style="color: #001080">authorization</span><span style="color: #000000"> === </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000"> ){</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">return</span><span style="color: #000000"> { </span><span style="color: #001080">role:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000"> };</span>
<span style="color: #000000">		} </span><span style="color: #AF00DB">else</span><span style="color: #000000"> </span><span style="color: #AF00DB">if</span><span style="color: #000000">( </span><span style="color: #001080">authorization</span><span style="color: #000000"> === </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000"> ){</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">return</span><span style="color: #000000"> { </span><span style="color: #001080">role:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000"> };</span>
<span style="color: #000000">		} </span><span style="color: #AF00DB">else</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #0000FF">undefined</span><span style="color: #000000">;</span>
<span style="color: #000000">		}</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</details></p>
				<p>Assuming the guard does the following (see above for an example implementation):</p>
				<ul>
					<li>Users without an <code>Authorization</code> header will see an <code>Unauthorized</code> exception.</li>
					<li>Users with an invalid <code>Authorization</code> header will see a <code>Forbidden</code> exception.</li>
					<li>Users with a valid <code>Authorization</code> header will be allowed to continue, and the property <code>user</code> is set on the <code>request</code>.</li>
				</ul>
				<blockquote>
					<p>Yeah, I&#39;m aware that in an ideal world, a <a href="https://docs.nestjs.com/middleware"><code>Middleware</code></a> or an <a href="https://docs.nestjs.com/interceptors"><code>Interceptor</code></a> should take care of setting the <code>user</code> property on the <code>Request</code>. But fact is that <a href="https://www.npmjs.com/package/@nestjs/passport"><code>@nestjs/passport</code></a> does it <a href="https://github.com/nestjs/passport/blob/6aef921c7566766d0eb9e79d2c8235177c539863/lib/auth.guard.ts#L58">in a guard</a></p>
				</blockquote>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/naive.controller.ts#L1-L15">./src/controllers/naive.controller.ts</a></p>
						<pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Controller</span><span style="color: #000000">, </span><span style="color: #001080">Get</span><span style="color: #000000">, </span><span style="color: #001080">UseGuards</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Policy</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@scitizen/nest-casl&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">NaiveGuard</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./naive.guard&#039;</span><span style="color: #000000">;</span>

<span style="color: #000000">@</span><span style="color: #795E26">Controller</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">@</span><span style="color: #795E26">Policy</span><span style="color: #000000">( { </span><span style="color: #001080">action:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #001080">subject:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> } ) </span><span style="color: #008000">// **MUST** be above the guard extracting infos from your request.</span>
<span style="color: #000000">@</span><span style="color: #795E26">UseGuards</span><span style="color: #000000">( </span><span style="color: #001080">NaiveGuard</span><span style="color: #000000"> )</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">NaiveTestController</span><span style="color: #000000"> {</span>
<span style="color: #000000">	@</span><span style="color: #795E26">Get</span><span style="color: #000000">()</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">method</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #008000">// ...</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</div></p>
				<p>Now,</p>
				<ul>
					<li>Users without an <code>Authorization</code> header will see an <code>Unauthorized</code> exception (from the <code>NaiveGuard</code>).</li>
					<li>Users with an invalid <code>Authorization</code> header will see a <code>Forbidden</code> exception (from the <code>NaiveGuard</code>).</li>
					<li>Users with an <code>Authorization</code> header that does not give them access to the ressource will see a <code>Forbidden</code> exception (from the {@link PoliciesGuard <code>PoliciesGuard</code>}).</li>
					<li>Users with an <code>Authorization</code> header that give them access to the ressource will succeed.</li>
				</ul>
				<a href="#using-nestjspassport" id="using-nestjspassport" style="color: inherit; text-decoration: none;">
					<h2>Using <a href="https://www.npmjs.com/package/@nestjs/passport"><code>@nestjs/passport</code></a></h2>
				</a>
				<p>If you&#39;re using <code>passport</code>, you can delegate the user retrieval. Let&#39;s say you have a JWT <code>passport</code> strategy.</p>
				<p><details class="code-block"><summary><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/jwt-passport.strategy.ts#L1-L18">./src/strategies/jwt-passport.strategy.ts</a></p>
						</summary><pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Injectable</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">PassportStrategy</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/passport&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">ExtractJwt</span><span style="color: #000000">, </span><span style="color: #001080">Strategy</span><span style="color: #000000">, </span><span style="color: #001080">StrategyOptions</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;passport-jwt&#039;</span><span style="color: #000000">;</span>

<span style="color: #000000">@</span><span style="color: #795E26">Injectable</span><span style="color: #000000">()</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">JwtPassportStrategy</span><span style="color: #000000"> </span><span style="color: #0000FF">extends</span><span style="color: #000000"> </span><span style="color: #795E26">PassportStrategy</span><span style="color: #000000">( </span><span style="color: #001080">Strategy</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;jwt&#039;</span><span style="color: #000000"> ) {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">static</span><span style="color: #000000"> </span><span style="color: #0000FF">readonly</span><span style="color: #000000"> </span><span style="color: #001080">KEY</span><span style="color: #000000"> = </span><span style="color: #A31515">&#039;this-is-a-secret&#039;</span><span style="color: #000000">;</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #0000FF">constructor</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #0000FF">super</span><span style="color: #000000">( {</span>
<span style="color: #000000">			</span><span style="color: #001080">jwtFromRequest:</span><span style="color: #000000"> </span><span style="color: #001080">ExtractJwt</span><span style="color: #000000">.</span><span style="color: #795E26">fromAuthHeaderAsBearerToken</span><span style="color: #000000">(),</span>
<span style="color: #000000">			</span><span style="color: #001080">secretOrKey:</span><span style="color: #000000"> </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000">.</span><span style="color: #0070C1">KEY</span><span style="color: #000000">,</span>
<span style="color: #000000">		} </span><span style="color: #AF00DB">as</span><span style="color: #000000"> </span><span style="color: #267F99">StrategyOptions</span><span style="color: #000000"> );</span>
<span style="color: #000000">	}</span>

<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">validate</span><span style="color: #000000">( </span><span style="color: #001080">user</span><span style="color: #000000">: </span><span style="color: #267F99">any</span><span style="color: #000000"> ){</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #001080">user</span><span style="color: #000000">;</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</details></p>
				<p>Still using the naive approach, you can then declare the controller like this:</p>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/passport-naive.controller.ts#L1-L14">./src/controllers/passport-naive.controller.ts</a></p>
						<pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Controller</span><span style="color: #000000">, </span><span style="color: #001080">Get</span><span style="color: #000000">, </span><span style="color: #001080">UseGuards</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">AuthGuard</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/passport&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Policy</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@scitizen/nest-casl&#039;</span><span style="color: #000000">;</span>

<span style="color: #000000">@</span><span style="color: #795E26">Controller</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/passport/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">@</span><span style="color: #795E26">Policy</span><span style="color: #000000">( { </span><span style="color: #001080">action:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #001080">subject:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> } ) </span><span style="color: #008000">// **MUST** be above the guard extracting infos from your request.</span>
<span style="color: #000000">@</span><span style="color: #795E26">UseGuards</span><span style="color: #000000">( </span><span style="color: #795E26">AuthGuard</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;jwt&#039;</span><span style="color: #000000"> ) )</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">PassportNaiveTestController</span><span style="color: #000000"> {</span>
<span style="color: #000000">	@</span><span style="color: #795E26">Get</span><span style="color: #000000">()</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">method</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #008000">// ...</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</div></p>
				<a href="#the-tests" id="the-tests" style="color: inherit; text-decoration: none;">
					<h2>The tests</h2>
				</a>
				<p>Wanna see the behavior as tests ? Here you are !</p>
				<p><details class="code-block"><summary><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/naive-test.e2e-spec.ts#L1-L77">./test/demo/use-with-guards/naive-test.e2e-spec.ts#1~77</a></p>
						</summary><pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">, </span><span style="color: #001080">INestApplication</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">JwtModule</span><span style="color: #000000">, </span><span style="color: #001080">JwtService</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/jwt&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Test</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/testing&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> </span><span style="color: #001080">request</span><span style="color: #000000"> </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;supertest&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">CaslModule</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@scitizen/nest-casl&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./ability-factory.service&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./jwt-passport.strategy&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">NaiveTestController</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./naive.controller&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">PassportNaiveTestController</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./passport-naive.controller&#039;</span><span style="color: #000000">;</span>

<span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Use with guards (naive)&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">let</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">: </span><span style="color: #267F99">INestApplication</span><span style="color: #000000">;</span>

<span style="color: #000000">	</span><span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;NaiveTestController&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #795E26">beforeAll</span><span style="color: #000000">( </span><span style="color: #0000FF">async</span><span style="color: #000000"> () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">moduleRef</span><span style="color: #000000"> = </span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">Test</span><span style="color: #000000">.</span><span style="color: #795E26">createTestingModule</span><span style="color: #000000">( {</span>
<span style="color: #000000">				</span><span style="color: #001080">imports:</span><span style="color: #000000"> [</span>
<span style="color: #000000">					</span><span style="color: #001080">CaslModule</span><span style="color: #000000">.</span><span style="color: #795E26">withConfig</span><span style="color: #000000">( ( { </span><span style="color: #001080">abilityFactory:</span><span style="color: #000000"> </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } ) ),</span>
<span style="color: #000000">				],</span>
<span style="color: #000000">				</span><span style="color: #001080">controllers:</span><span style="color: #000000"> [ </span><span style="color: #001080">NaiveTestController</span><span style="color: #000000"> ],</span>
<span style="color: #000000">			} ).</span><span style="color: #795E26">compile</span><span style="color: #000000">();</span>

<span style="color: #000000">			</span><span style="color: #001080">app</span><span style="color: #000000"> = </span><span style="color: #001080">moduleRef</span><span style="color: #000000">.</span><span style="color: #795E26">createNestApplication</span><span style="color: #000000">();</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">init</span><span style="color: #000000">();</span>
<span style="color: #000000">		} );</span>

<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send an UNAUTHORIZED error if no authorization set&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Missing authorization header&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Unauthorized&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if invalid authorization&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;invalid&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden resource&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if invalid capabilities&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Invalid authorizations: Can</span><span style="color: #EE0000">\&#039;</span><span style="color: #A31515">t &quot;admin&quot; on &quot;something&quot;&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should work&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">OK</span><span style="color: #000000"> ) );</span>
<span style="color: #000000">	} );</span>
<span style="color: #000000">	</span><span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;PassportNaiveTestController&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #795E26">beforeAll</span><span style="color: #000000">( </span><span style="color: #0000FF">async</span><span style="color: #000000"> () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">moduleRef</span><span style="color: #000000"> = </span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">Test</span><span style="color: #000000">.</span><span style="color: #795E26">createTestingModule</span><span style="color: #000000">( {</span>
<span style="color: #000000">				</span><span style="color: #001080">imports:</span><span style="color: #000000"> [</span>
<span style="color: #000000">					</span><span style="color: #001080">CaslModule</span><span style="color: #000000">.</span><span style="color: #795E26">withConfig</span><span style="color: #000000">( ( { </span><span style="color: #001080">abilityFactory:</span><span style="color: #000000"> </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } ) ),</span>
<span style="color: #000000">					</span><span style="color: #001080">JwtModule</span><span style="color: #000000">.</span><span style="color: #795E26">register</span><span style="color: #000000">( { </span><span style="color: #001080">secret:</span><span style="color: #000000"> </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000">.</span><span style="color: #0070C1">KEY</span><span style="color: #000000"> } ),</span>
<span style="color: #000000">				],</span>
<span style="color: #000000">				</span><span style="color: #001080">providers:</span><span style="color: #000000"> [ </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000"> ],</span>
<span style="color: #000000">				</span><span style="color: #001080">controllers:</span><span style="color: #000000"> [ </span><span style="color: #001080">PassportNaiveTestController</span><span style="color: #000000"> ],</span>
<span style="color: #000000">			} ).</span><span style="color: #795E26">compile</span><span style="color: #000000">();</span>

<span style="color: #000000">			</span><span style="color: #001080">app</span><span style="color: #000000"> = </span><span style="color: #001080">moduleRef</span><span style="color: #000000">.</span><span style="color: #795E26">createNestApplication</span><span style="color: #000000">();</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">init</span><span style="color: #000000">();</span>
<span style="color: #000000">		} );</span>

<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send an UNAUTHORIZED error if no authorization set&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/passport/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Unauthorized&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if invalid capabilities&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/passport/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Invalid authorizations: Can</span><span style="color: #EE0000">\&#039;</span><span style="color: #A31515">t &quot;admin&quot; on &quot;something&quot;&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should work&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/passport/naive&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">OK</span><span style="color: #000000"> ) );</span>
<span style="color: #000000">	} );</span>
<span style="color: #000000">} );</span>
</code></pre>
				</details></p>
				<a href="#the-recommended-approach" id="the-recommended-approach" style="color: inherit; text-decoration: none;">
					<h1>The recommended approach</h1>
				</a>
				<p>What&#39;s the problem about the naïve approach above ? Well, there are 2.</p>
				<ol>
					<li><em>The readability</em>: The <code>UseGuards</code> decorator is placed <strong>below</strong> the <a href="../../modules.html#Policy"><code>Policy</code></a> decorator, but is ran <strong>before</strong> it.</li>
					<li><em>The reusability</em>: If you&#39;re using multiple authentication strategies in the same app, you might have to apply guards <strong>and</strong> the policies on each method depending on the context. Moreover, if you want to type-check your policies, you might prefer to have abilities presets.</li>
				</ol>
				<a href="#about-readability" id="about-readability" style="color: inherit; text-decoration: none;">
					<h2>About readability</h2>
				</a>
				<p>You can use <a href="../../modules/Policy.html#usingGuard"><code>Policy.usingGuard</code></a> or <a href="../../modules/PoliciesMask.html#usingGuard"><code>PoliciesMask.usingGuard</code></a> to prepended guards to the decorator factory. Those calls are cumulative, and you can do multiple subsequent calls to join guards using an <code>and</code> condition. If you provide an array of guards, they be evaluated using an <code>or</code> condition.</p>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/recommended.controller.ts#L7-L15">./src/controllers/recommended.controller.ts</a></p>
						<pre><code class="language-ts"><span style="color: #000000">@</span><span style="color: #795E26">Controller</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/recommended&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">@</span><span style="color: #795E26">Policy</span><span style="color: #000000">( { </span><span style="color: #001080">action:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #001080">subject:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> } )</span>
<span style="color: #000000">	.</span><span style="color: #795E26">usingGuard</span><span style="color: #000000">( </span><span style="color: #795E26">AuthGuard</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;jwt&#039;</span><span style="color: #000000"> ) ) </span><span style="color: #008000">// The policy will run the guard before doing its own checks.</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">RecommendedTestController</span><span style="color: #000000"> {</span>
<span style="color: #000000">	@</span><span style="color: #795E26">Get</span><span style="color: #000000">()</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">method</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #008000">// ...</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</div></p>
				<a href="#about-reusability" id="about-reusability" style="color: inherit; text-decoration: none;">
					<h2>About reusability</h2>
				</a>
				<p>You can even prepare a policy decorator with guards or <a href="../../modules.html#PolicyDescriptor"><code>PolicyDescriptor</code></a>:</p>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/recommended.controller.ts#L19-L21">./src/policies.ts</a></p>
						<pre><code class="language-ts"><span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">AdminViaJwtPolicy</span><span style="color: #000000"> = </span><span style="color: #795E26">Policy</span><span style="color: #000000">( { </span><span style="color: #001080">action:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #001080">subject:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> } )</span>
<span style="color: #000000">	.</span><span style="color: #795E26">usingGuard</span><span style="color: #000000">( </span><span style="color: #795E26">AuthGuard</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;jwt&#039;</span><span style="color: #000000"> ) );</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">ViaJwtPolicy</span><span style="color: #000000"> = </span><span style="color: #001080">Policy</span><span style="color: #000000">.</span><span style="color: #795E26">usingGuard</span><span style="color: #000000">( </span><span style="color: #795E26">AuthGuard</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;jwt&#039;</span><span style="color: #000000"> ) );</span>
</code></pre>
				</div></p>
				<p>Then, use those presets in your controller:</p>
				<p><div class="code-block"><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/recommended.controller.ts#L25-L56">./src/recommended-bound.controller.ts</a></p>
						<pre><code class="language-ts"><span style="color: #000000">@</span><span style="color: #795E26">Injectable</span><span style="color: #000000">()</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">ExtraGuard1</span><span style="color: #000000"> </span><span style="color: #0000FF">implements</span><span style="color: #000000"> </span><span style="color: #267F99">CanActivate</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">canActivate</span><span style="color: #000000">( </span><span style="color: #001080">context</span><span style="color: #000000">: </span><span style="color: #267F99">ExecutionContext</span><span style="color: #000000"> ): </span><span style="color: #267F99">boolean</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">if</span><span style="color: #000000">( !</span><span style="color: #001080">context</span><span style="color: #000000">.</span><span style="color: #795E26">switchToHttp</span><span style="color: #000000">().</span><span style="color: #795E26">getRequest</span><span style="color: #000000">().</span><span style="color: #001080">user</span><span style="color: #000000">.</span><span style="color: #001080">allowed1</span><span style="color: #000000"> ){</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">throw</span><span style="color: #000000"> </span><span style="color: #0000FF">new</span><span style="color: #000000"> </span><span style="color: #795E26">BadRequestException</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Not allowed from ExtraGuard1&#039;</span><span style="color: #000000"> );</span>
<span style="color: #000000">		}</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #0000FF">true</span><span style="color: #000000">;</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
<span style="color: #000000">@</span><span style="color: #795E26">Injectable</span><span style="color: #000000">()</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">ExtraGuard2</span><span style="color: #000000"> </span><span style="color: #0000FF">implements</span><span style="color: #000000"> </span><span style="color: #267F99">CanActivate</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">canActivate</span><span style="color: #000000">( </span><span style="color: #001080">context</span><span style="color: #000000">: </span><span style="color: #267F99">ExecutionContext</span><span style="color: #000000"> ): </span><span style="color: #267F99">boolean</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #AF00DB">return</span><span style="color: #000000"> </span><span style="color: #001080">context</span><span style="color: #000000">.</span><span style="color: #795E26">switchToHttp</span><span style="color: #000000">().</span><span style="color: #795E26">getRequest</span><span style="color: #000000">().</span><span style="color: #001080">user</span><span style="color: #000000">.</span><span style="color: #001080">allowed2</span><span style="color: #000000"> ?? </span><span style="color: #0000FF">false</span><span style="color: #000000">;</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>

<span style="color: #000000">@</span><span style="color: #795E26">Controller</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/recommended/bound&#039;</span><span style="color: #000000"> )</span>
<span style="color: #AF00DB">export</span><span style="color: #000000"> </span><span style="color: #0000FF">class</span><span style="color: #000000"> </span><span style="color: #267F99">RecommendedBoundTestController</span><span style="color: #000000"> {</span>
<span style="color: #000000">	@</span><span style="color: #795E26">Get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;method1&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">	@</span><span style="color: #001080">AdminViaJwtPolicy</span>
<span style="color: #000000">		.</span><span style="color: #795E26">usingGuard</span><span style="color: #000000">( [ </span><span style="color: #001080">ExtraGuard1</span><span style="color: #000000">, </span><span style="color: #001080">ExtraGuard2</span><span style="color: #000000"> ] ) </span><span style="color: #008000">// Add guards. When passed as an array, if either one can activate, it will continue</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">method1</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #008000">// ...</span>
<span style="color: #000000">	}</span>

<span style="color: #000000">	@</span><span style="color: #795E26">Get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;method2&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">	@</span><span style="color: #795E26">ViaJwtPolicy</span><span style="color: #000000">( { </span><span style="color: #001080">action:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000">, </span><span style="color: #001080">subject:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;something&#039;</span><span style="color: #000000"> } )</span>
<span style="color: #000000">		.</span><span style="color: #795E26">usingGuard</span><span style="color: #000000">( [ </span><span style="color: #001080">ExtraGuard1</span><span style="color: #000000">, </span><span style="color: #001080">ExtraGuard2</span><span style="color: #000000"> ] ) </span><span style="color: #008000">// Add guards. When passed as an array, if either one can activate, it will continue</span>
<span style="color: #000000">	</span><span style="color: #0000FF">public</span><span style="color: #000000"> </span><span style="color: #795E26">method2</span><span style="color: #000000">(){</span>
<span style="color: #000000">		</span><span style="color: #008000">// ...</span>
<span style="color: #000000">	}</span>
<span style="color: #000000">}</span>
</code></pre>
				</div></p>
				<p>Now, both <code>method1</code> and <code>method2</code> will run if</p>
				<ul>
					<li>the user is authenticated through <code>jwt</code> strategy</li>
					<li>it passes either <code>ExtraGuard1</code> or <code>ExtraGuard2</code></li>
					<li>and he has admin role.</li>
				</ul>
				<blockquote>
					<p>Note that you can use <a href="../../modules.html#bindPolicyDecorators"><code>bindPolicyDecorators</code></a> to bind <em>both</em> <a href="../../modules.html#Policy"><code>Policy</code></a> and <a href="../../modules.html#PoliciesMask"><code>PoliciesMask</code></a></p>
				</blockquote>
				<a href="#the-tests-1" id="the-tests-1" style="color: inherit; text-decoration: none;">
					<h2>The tests</h2>
				</a>
				<p>This is tested, of course. Just see by yourself.</p>
				<p><details class="code-block"><summary><p style="margin-bottom: 0;">From <a href="https://github.com/Scitizen/nest-casl/blob/v0.0.1-alpha1/test/demo/use-with-guards/recommended-test.e2e-spec.ts#L1-L90">./test/demo/use-with-guards/recommended-test.e2e-spec.ts#1~90</a></p>
						</summary><pre><code class="language-ts"><span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">, </span><span style="color: #001080">INestApplication</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/common&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">JwtModule</span><span style="color: #000000">, </span><span style="color: #001080">JwtService</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/jwt&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">Test</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@nestjs/testing&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> </span><span style="color: #001080">request</span><span style="color: #000000"> </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;supertest&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">CaslModule</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;@scitizen/nest-casl&#039;</span><span style="color: #000000">;</span>

<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./ability-factory.service&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./jwt-passport.strategy&#039;</span><span style="color: #000000">;</span>
<span style="color: #AF00DB">import</span><span style="color: #000000"> { </span><span style="color: #001080">ExtraGuard1</span><span style="color: #000000">, </span><span style="color: #001080">ExtraGuard2</span><span style="color: #000000">, </span><span style="color: #001080">RecommendedBoundTestController</span><span style="color: #000000">, </span><span style="color: #001080">RecommendedTestController</span><span style="color: #000000"> } </span><span style="color: #AF00DB">from</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;./recommended.controller&#039;</span><span style="color: #000000">;</span>

<span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Use with guards (recommended)&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">	</span><span style="color: #0000FF">let</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">: </span><span style="color: #267F99">INestApplication</span><span style="color: #000000">;</span>

<span style="color: #000000">	</span><span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;RecommendedTestController&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #795E26">beforeAll</span><span style="color: #000000">( </span><span style="color: #0000FF">async</span><span style="color: #000000"> () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">moduleRef</span><span style="color: #000000"> = </span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">Test</span><span style="color: #000000">.</span><span style="color: #795E26">createTestingModule</span><span style="color: #000000">( {</span>
<span style="color: #000000">				</span><span style="color: #001080">imports:</span><span style="color: #000000"> [</span>
<span style="color: #000000">					</span><span style="color: #001080">CaslModule</span><span style="color: #000000">.</span><span style="color: #795E26">withConfig</span><span style="color: #000000">( ( { </span><span style="color: #001080">abilityFactory:</span><span style="color: #000000"> </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } ) ),</span>
<span style="color: #000000">					</span><span style="color: #001080">JwtModule</span><span style="color: #000000">.</span><span style="color: #795E26">register</span><span style="color: #000000">( { </span><span style="color: #001080">secret:</span><span style="color: #000000"> </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000">.</span><span style="color: #0070C1">KEY</span><span style="color: #000000"> } ),</span>
<span style="color: #000000">				],</span>
<span style="color: #000000">				</span><span style="color: #001080">providers:</span><span style="color: #000000"> [ </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000"> ],</span>
<span style="color: #000000">				</span><span style="color: #001080">controllers:</span><span style="color: #000000"> [ </span><span style="color: #001080">RecommendedTestController</span><span style="color: #000000"> ],</span>
<span style="color: #000000">			} ).</span><span style="color: #795E26">compile</span><span style="color: #000000">();</span>

<span style="color: #000000">			</span><span style="color: #001080">app</span><span style="color: #000000"> = </span><span style="color: #001080">moduleRef</span><span style="color: #000000">.</span><span style="color: #795E26">createNestApplication</span><span style="color: #000000">();</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">init</span><span style="color: #000000">();</span>
<span style="color: #000000">		} );</span>

<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send an UNAUTHORIZED error if no authorization set&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/recommended&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Unauthorized&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if invalid capabilities&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/recommended&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Invalid authorizations: Can</span><span style="color: #EE0000">\&#039;</span><span style="color: #A31515">t &quot;admin&quot; on &quot;something&quot;&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">		</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should work&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;/recommended&#039;</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">			.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">OK</span><span style="color: #000000"> ) );</span>
<span style="color: #000000">	} );</span>
<span style="color: #000000">	</span><span style="color: #795E26">describe</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;RecommendedBoundTestController&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">		</span><span style="color: #795E26">beforeAll</span><span style="color: #000000">( </span><span style="color: #0000FF">async</span><span style="color: #000000"> () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">moduleRef</span><span style="color: #000000"> = </span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">Test</span><span style="color: #000000">.</span><span style="color: #795E26">createTestingModule</span><span style="color: #000000">( {</span>
<span style="color: #000000">				</span><span style="color: #001080">imports:</span><span style="color: #000000"> [</span>
<span style="color: #000000">					</span><span style="color: #001080">CaslModule</span><span style="color: #000000">.</span><span style="color: #795E26">withConfig</span><span style="color: #000000">( ( { </span><span style="color: #001080">abilityFactory:</span><span style="color: #000000"> </span><span style="color: #001080">AbilityFactory</span><span style="color: #000000"> } ) ),</span>
<span style="color: #000000">					</span><span style="color: #001080">JwtModule</span><span style="color: #000000">.</span><span style="color: #795E26">register</span><span style="color: #000000">( { </span><span style="color: #001080">secret:</span><span style="color: #000000"> </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000">.</span><span style="color: #0070C1">KEY</span><span style="color: #000000"> } ),</span>
<span style="color: #000000">				],</span>
<span style="color: #000000">				</span><span style="color: #001080">providers:</span><span style="color: #000000"> [ </span><span style="color: #001080">JwtPassportStrategy</span><span style="color: #000000">, </span><span style="color: #001080">ExtraGuard1</span><span style="color: #000000">, </span><span style="color: #001080">ExtraGuard2</span><span style="color: #000000"> ],</span>
<span style="color: #000000">				</span><span style="color: #001080">controllers:</span><span style="color: #000000"> [ </span><span style="color: #001080">RecommendedBoundTestController</span><span style="color: #000000"> ],</span>
<span style="color: #000000">			} ).</span><span style="color: #795E26">compile</span><span style="color: #000000">();</span>

<span style="color: #000000">			</span><span style="color: #001080">app</span><span style="color: #000000"> = </span><span style="color: #001080">moduleRef</span><span style="color: #000000">.</span><span style="color: #795E26">createNestApplication</span><span style="color: #000000">();</span>
<span style="color: #000000">			</span><span style="color: #AF00DB">await</span><span style="color: #000000"> </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">init</span><span style="color: #000000">();</span>
<span style="color: #000000">		} );</span>

<span style="color: #000000">		</span><span style="color: #001080">describe</span><span style="color: #000000">.</span><span style="color: #795E26">each</span><span style="color: #000000">( [ </span><span style="color: #A31515">&#039;method1&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">&#039;method2&#039;</span><span style="color: #000000"> ] )( </span><span style="color: #A31515">&#039;On method %s&#039;</span><span style="color: #000000">, </span><span style="color: #001080">method</span><span style="color: #000000"> </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> {</span>
<span style="color: #000000">			</span><span style="color: #0000FF">const</span><span style="color: #000000"> </span><span style="color: #0070C1">endpoint</span><span style="color: #000000"> = </span><span style="color: #A31515">`/recommended/bound/</span><span style="color: #0000FF">${</span><span style="color: #001080">method</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000">;</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send an UNAUTHORIZED error if no authorization set&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">UNAUTHORIZED</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Unauthorized&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if passing neither guard 1 nor 2, and throw error from guard 1&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed1:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">false</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed2:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">false</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">BAD_REQUEST</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">BAD_REQUEST</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Not allowed from ExtraGuard1&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Bad Request&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if passing guard 1 invalid capabilities&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed1:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">true</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Invalid authorizations: Can</span><span style="color: #EE0000">\&#039;</span><span style="color: #A31515">t &quot;admin&quot; on &quot;something&quot;&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should send a FORBIDDEN error if passing guard 2 invalid capabilities&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;user&#039;</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed2:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">true</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( { </span><span style="color: #001080">statusCode:</span><span style="color: #000000"> </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">FORBIDDEN</span><span style="color: #000000">, </span><span style="color: #001080">message:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Invalid authorizations: Can</span><span style="color: #EE0000">\&#039;</span><span style="color: #A31515">t &quot;admin&quot; on &quot;something&quot;&#039;</span><span style="color: #000000">, </span><span style="color: #001080">error:</span><span style="color: #000000"> </span><span style="color: #A31515">&#039;Forbidden&#039;</span><span style="color: #000000"> } ) );</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should work via guard 1&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed1:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">true</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">OK</span><span style="color: #000000"> ) );</span>
<span style="color: #000000">			</span><span style="color: #795E26">it</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;should work via guard 2&#039;</span><span style="color: #000000">, () </span><span style="color: #0000FF">=&gt;</span><span style="color: #000000"> </span><span style="color: #795E26">request</span><span style="color: #000000">( </span><span style="color: #001080">app</span><span style="color: #000000">.</span><span style="color: #795E26">getHttpServer</span><span style="color: #000000">() )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">get</span><span style="color: #000000">( </span><span style="color: #001080">endpoint</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">set</span><span style="color: #000000">( </span><span style="color: #A31515">&#039;Authorization&#039;</span><span style="color: #000000">, </span><span style="color: #A31515">`Bearer </span><span style="color: #0000FF">${</span><span style="color: #001080">app</span><span style="color: #000000FF">.</span><span style="color: #795E26">get</span><span style="color: #000000FF">( </span><span style="color: #001080">JwtService</span><span style="color: #000000FF"> ).</span><span style="color: #795E26">sign</span><span style="color: #000000FF">( { </span><span style="color: #001080">role:</span><span style="color: #000000FF"> </span><span style="color: #A31515">&#039;admin&#039;</span><span style="color: #000000FF">, </span><span style="color: #001080">allowed2:</span><span style="color: #000000FF"> </span><span style="color: #0000FF">true</span><span style="color: #000000FF"> } )</span><span style="color: #0000FF">}</span><span style="color: #A31515">`</span><span style="color: #000000"> )</span>
<span style="color: #000000">				.</span><span style="color: #795E26">expect</span><span style="color: #000000">( </span><span style="color: #001080">HttpStatus</span><span style="color: #000000">.</span><span style="color: #0070C1">OK</span><span style="color: #000000"> ) );</span>
<span style="color: #000000">		} );</span>
<span style="color: #000000">	} );</span>
<span style="color: #000000">} );</span>
</code></pre>
				</details></p>
				<a href="#what-next-" id="what-next-" style="color: inherit; text-decoration: none;">
					<h1>What next ?</h1>
				</a>
				<p><a href="better-type-constraints.html">Better type constraints</a></p>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="label pp-nav pp-group">
						<span>Guides</span>
					</li>
					<li class=" pp-nav pp-page">
						<a href="getting-started.html">Getting started</a>
					</li>
					<li class="current pp-nav pp-page">
						<a href="use-with-guards.html">Use with guards</a>
					</li>
					<li class=" pp-nav pp-page">
						<a href="better-type-constraints.html">Better type constraints</a>
					</li>
					<li class="label pp-nav pp-group">
						<span>API</span>
					</li>
					<li class=" ">
						<a href="../../modules.html">Exports</a>
					</li>
					<li class=" tsd-kind-namespace">
						<a href="../../modules/PoliciesMask.html">Policies<wbr>Mask</a>
					</li>
					<li class=" tsd-kind-namespace">
						<a href="../../modules/Policy.html">Policy</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer class="with-border-bottom">
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li>
				<li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-method tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="container tsd-generator">
	<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p>
</div>
<div class="overlay"></div>
<script src="../../assets/js/main.js"></script>
<script>if (location.protocol == 'file:') document.write('<script src="../../assets/js/search.json"><' + '/script>');</script>
</body>
</html>