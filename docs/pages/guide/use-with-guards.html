<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Use with guards | @knodes/nest-casl</title><meta name="description" content="Documentation for @knodes/nest-casl"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../../assets/style.css"/><link rel="stylesheet" href="../../assets/highlight.css"/><script async src="../../assets/search.js" id="search-script"></script><link rel="stylesheet" href="../../assets/code-blocks.css"/><link rel="stylesheet" href="../../assets/pages.css"/></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="../.."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../../index.html" class="title">@knodes/nest-casl</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><ul class="tsd-breadcrumb"><li><a href="../../modules.html">@knodes/nest-casl</a></li><li><span>Guides</span></li><li><a href="use-with-guards.html">Use with guards</a></li></ul><h1> Use with guards</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography"><p>Most of the times, you want to execute some guards before checking CASL policies, to extract some user informations before generating its abilities.</p>
<p>This page will show you the various way to do.</p>
<p>Let&#39;s assume you have the following <a href="../../interfaces/CaslAbilityFactory.html"><code>CaslAbilityFactory</code></a>:</p>
<details class="code-block" open><summary><p>From src/ability-factory.service.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">AbilityBuilder</span><span class="hl-0">, </span><span class="hl-4">PureAbility</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@casl/ability&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Injectable</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">CaslAbilityFactory</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@knodes/nest-casl&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-0">@</span><span class="hl-1">Injectable</span><span class="hl-0">()</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">AbilityFactory</span><span class="hl-0"> </span><span class="hl-2">implements</span><span class="hl-0"> </span><span class="hl-5">CaslAbilityFactory</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-3">// Here, \`request\` is the express or fastify request. You might get infos from it.</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">createFromRequest</span><span class="hl-0">( </span><span class="hl-4">_request</span><span class="hl-0">: </span><span class="hl-5">unknown</span><span class="hl-0"> ): </span><span class="hl-5">PureAbility</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-2">const</span><span class="hl-0"> { </span><span class="hl-7">user</span><span class="hl-0"> } = ( </span><span class="hl-4">_request</span><span class="hl-0"> </span><span class="hl-8">as</span><span class="hl-0"> </span><span class="hl-5">any</span><span class="hl-0"> );</span><br/><span class="hl-0">        </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">abilityBuilder</span><span class="hl-0"> = </span><span class="hl-2">new</span><span class="hl-0"> </span><span class="hl-1">AbilityBuilder</span><span class="hl-0">( </span><span class="hl-4">PureAbility</span><span class="hl-0"> );</span><br/><span class="hl-0">        </span><span class="hl-8">if</span><span class="hl-0">( </span><span class="hl-4">user</span><span class="hl-0">?.</span><span class="hl-4">role</span><span class="hl-0"> === </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0"> ) {</span><br/><span class="hl-0">            </span><span class="hl-4">abilityBuilder</span><span class="hl-0">.</span><span class="hl-1">can</span><span class="hl-0">( </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> );</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">        </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-4">abilityBuilder</span><span class="hl-0">.</span><span class="hl-1">build</span><span class="hl-0">();</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/>
</code></pre>
</details>


<a href="#the-na誰ve-approach" id="the-na誰ve-approach" style="color: inherit; text-decoration: none;">
  <h1>The na誰ve approach</h1>
</a>
<blockquote>
<p>This method is <strong>not recommanded</strong>. You might skip directly to the <a href="#the-recommended-approach">recommended approach</a></p>
</blockquote>

<a href="#without-any-more-dependencies" id="without-any-more-dependencies" style="color: inherit; text-decoration: none;">
  <h2>Without any more dependencies</h2>
</a>
<p>This method does not require any external dependency, and is as close to NestJS as possible.</p>
<details class="code-block"><summary><p>From src/guards/naive.guard.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">CanActivate</span><span class="hl-0">, </span><span class="hl-4">ExecutionContext</span><span class="hl-0">, </span><span class="hl-4">UnauthorizedException</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Request</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;express&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">NaiveGuard</span><span class="hl-0"> </span><span class="hl-2">implements</span><span class="hl-0"> </span><span class="hl-5">CanActivate</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">canActivate</span><span class="hl-0">( </span><span class="hl-4">context</span><span class="hl-0">: </span><span class="hl-5">ExecutionContext</span><span class="hl-0"> ): </span><span class="hl-5">boolean</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">request</span><span class="hl-0"> = </span><span class="hl-4">context</span><span class="hl-0">.</span><span class="hl-1">switchToHttp</span><span class="hl-0">().</span><span class="hl-1">getRequest</span><span class="hl-0">&lt;</span><span class="hl-5">Request</span><span class="hl-0">&gt;();</span><br/><span class="hl-0">        </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">authorization</span><span class="hl-0"> = </span><span class="hl-4">request</span><span class="hl-0">.</span><span class="hl-1">header</span><span class="hl-0">( </span><span class="hl-6">&#39;Authorization&#39;</span><span class="hl-0"> );</span><br/><span class="hl-0">        </span><span class="hl-8">if</span><span class="hl-0">( !</span><span class="hl-4">authorization</span><span class="hl-0"> ){</span><br/><span class="hl-0">            </span><span class="hl-3">// **BEWARE**: if the guard returns \`false\`, Nest will throw a \`ForbiddenException\` which is semantically incorrect here.</span><br/><span class="hl-0">            </span><span class="hl-3">// The user is not *missing the right to do*, it is *not authenticated at all*.</span><br/><span class="hl-0">            </span><span class="hl-8">throw</span><span class="hl-0"> </span><span class="hl-2">new</span><span class="hl-0"> </span><span class="hl-1">UnauthorizedException</span><span class="hl-0">( </span><span class="hl-6">&#39;Missing authorization header&#39;</span><span class="hl-0"> );</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">        </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">user</span><span class="hl-0"> = </span><span class="hl-2">this</span><span class="hl-0">.</span><span class="hl-1">_getUserFromAuthorization</span><span class="hl-0">( </span><span class="hl-4">authorization</span><span class="hl-0"> );</span><br/><span class="hl-0">        </span><span class="hl-8">if</span><span class="hl-0">( !</span><span class="hl-4">user</span><span class="hl-0"> ){</span><br/><span class="hl-0">            </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-2">false</span><span class="hl-0">;</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">        ( </span><span class="hl-4">request</span><span class="hl-0"> </span><span class="hl-8">as</span><span class="hl-0"> </span><span class="hl-5">any</span><span class="hl-0"> ).</span><span class="hl-4">user</span><span class="hl-0"> = </span><span class="hl-4">user</span><span class="hl-0">;</span><br/><span class="hl-0">        </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-2">true</span><span class="hl-0">;</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">private</span><span class="hl-0"> </span><span class="hl-1">_getUserFromAuthorization</span><span class="hl-0">( </span><span class="hl-4">authorization</span><span class="hl-0">?: </span><span class="hl-5">string</span><span class="hl-0"> ){</span><br/><span class="hl-0">        </span><span class="hl-8">if</span><span class="hl-0">( </span><span class="hl-4">authorization</span><span class="hl-0"> === </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0"> ){</span><br/><span class="hl-0">            </span><span class="hl-8">return</span><span class="hl-0"> { </span><span class="hl-4">role:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0"> };</span><br/><span class="hl-0">        } </span><span class="hl-8">else</span><span class="hl-0"> </span><span class="hl-8">if</span><span class="hl-0">( </span><span class="hl-4">authorization</span><span class="hl-0"> === </span><span class="hl-6">&#39;user&#39;</span><span class="hl-0"> ){</span><br/><span class="hl-0">            </span><span class="hl-8">return</span><span class="hl-0"> { </span><span class="hl-4">role:</span><span class="hl-0"> </span><span class="hl-6">&#39;user&#39;</span><span class="hl-0"> };</span><br/><span class="hl-0">        } </span><span class="hl-8">else</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-2">undefined</span><span class="hl-0">;</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/>
</code></pre>
</details>

<p>Assuming the guard does the following (see above for an example implementation):</p>
<ul>
<li>Users without an <code>Authorization</code> header will see an <code>Unauthorized</code> exception.</li>
<li>Users with an invalid <code>Authorization</code> header will see a <code>Forbidden</code> exception.</li>
<li>Users with a valid <code>Authorization</code> header will be allowed to continue, and the property <code>user</code> is set on the <code>request</code>.</li>
</ul>
<blockquote>
<p>Yeah, I&#39;m aware that in an ideal world, a <a href="https://docs.nestjs.com/middleware"><code>Middleware</code></a> or an <a href="https://docs.nestjs.com/interceptors"><code>Interceptor</code></a> should take care of setting the <code>user</code> property on the <code>Request</code>. But fact is that <a href="https://www.npmjs.com/package/@nestjs/passport"><code>@nestjs/passport</code></a> does it <a href="https://github.com/nestjs/passport/blob/6aef921c7566766d0eb9e79d2c8235177c539863/lib/auth.guard.ts#L58">in a guard</a></p>
</blockquote>
<details class="code-block" open><summary><p>From src/controllers/naive.controller.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Controller</span><span class="hl-0">, </span><span class="hl-4">Get</span><span class="hl-0">, </span><span class="hl-4">UseGuards</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Policy</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@knodes/nest-casl&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">NaiveGuard</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;./naive.guard&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-0">@</span><span class="hl-1">Controller</span><span class="hl-0">( </span><span class="hl-6">&#39;/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">@</span><span class="hl-1">Policy</span><span class="hl-0">( { </span><span class="hl-4">action:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-4">subject:</span><span class="hl-0"> </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> } ) </span><span class="hl-3">// **MUST** be above the guard extracting infos from your request.</span><br/><span class="hl-0">@</span><span class="hl-1">UseGuards</span><span class="hl-0">( </span><span class="hl-4">NaiveGuard</span><span class="hl-0"> )</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">NaiveTestController</span><span class="hl-0"> {</span><br/><span class="hl-0">    @</span><span class="hl-1">Get</span><span class="hl-0">()</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">method</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-3">// ...</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/>
</code></pre>
</details>

<p>Now,</p>
<ul>
<li>Users without an <code>Authorization</code> header will see an <code>Unauthorized</code> exception (from the <code>NaiveGuard</code>).</li>
<li>Users with an invalid <code>Authorization</code> header will see a <code>Forbidden</code> exception (from the <code>NaiveGuard</code>).</li>
<li>Users with an <code>Authorization</code> header that does not give them access to the ressource will see a <code>Forbidden</code> exception (from the {@link PoliciesGuard <code>PoliciesGuard</code>}).</li>
<li>Users with an <code>Authorization</code> header that give them access to the ressource will succeed.</li>
</ul>

<a href="#using-nestjspassport" id="using-nestjspassport" style="color: inherit; text-decoration: none;">
  <h2>Using <a href="https://www.npmjs.com/package/@nestjs/passport"><code>@nestjs/passport</code></a></h2>
</a>
<p>If you&#39;re using <code>passport</code>, you can delegate the user retrieval. Let&#39;s say you have a JWT <code>passport</code> strategy.</p>
<details class="code-block"><summary><p>From src/strategies/jwt-passport.strategy.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Injectable</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">PassportStrategy</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/passport&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">ExtractJwt</span><span class="hl-0">, </span><span class="hl-4">Strategy</span><span class="hl-0">, </span><span class="hl-4">StrategyOptions</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;passport-jwt&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-0">@</span><span class="hl-1">Injectable</span><span class="hl-0">()</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">JwtPassportStrategy</span><span class="hl-0"> </span><span class="hl-2">extends</span><span class="hl-0"> </span><span class="hl-1">PassportStrategy</span><span class="hl-0">( </span><span class="hl-4">Strategy</span><span class="hl-0">, </span><span class="hl-6">&#39;jwt&#39;</span><span class="hl-0"> ) {</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-2">static</span><span class="hl-0"> </span><span class="hl-2">readonly</span><span class="hl-0"> </span><span class="hl-4">KEY</span><span class="hl-0"> = </span><span class="hl-6">&#39;this-is-a-secret&#39;</span><span class="hl-0">;</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-2">constructor</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-2">super</span><span class="hl-0">( {</span><br/><span class="hl-0">            </span><span class="hl-4">jwtFromRequest:</span><span class="hl-0"> </span><span class="hl-4">ExtractJwt</span><span class="hl-0">.</span><span class="hl-1">fromAuthHeaderAsBearerToken</span><span class="hl-0">(),</span><br/><span class="hl-0">            </span><span class="hl-4">secretOrKey:</span><span class="hl-0"> </span><span class="hl-4">JwtPassportStrategy</span><span class="hl-0">.</span><span class="hl-7">KEY</span><span class="hl-0">,</span><br/><span class="hl-0">        } </span><span class="hl-8">as</span><span class="hl-0"> </span><span class="hl-5">StrategyOptions</span><span class="hl-0"> );</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">validate</span><span class="hl-0">( </span><span class="hl-4">user</span><span class="hl-0">: </span><span class="hl-5">any</span><span class="hl-0"> ){</span><br/><span class="hl-0">        </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-4">user</span><span class="hl-0">;</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/>
</code></pre>
</details>

<p>Still using the naive approach, you can then declare the controller like this:</p>
<details class="code-block" open><summary><p>From src/controllers/passport-naive.controller.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Controller</span><span class="hl-0">, </span><span class="hl-4">Get</span><span class="hl-0">, </span><span class="hl-4">UseGuards</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">AuthGuard</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/passport&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Policy</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@knodes/nest-casl&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-0">@</span><span class="hl-1">Controller</span><span class="hl-0">( </span><span class="hl-6">&#39;/passport/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">@</span><span class="hl-1">Policy</span><span class="hl-0">( { </span><span class="hl-4">action:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-4">subject:</span><span class="hl-0"> </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> } ) </span><span class="hl-3">// **MUST** be above the guard extracting infos from your request.</span><br/><span class="hl-0">@</span><span class="hl-1">UseGuards</span><span class="hl-0">( </span><span class="hl-1">AuthGuard</span><span class="hl-0">( </span><span class="hl-6">&#39;jwt&#39;</span><span class="hl-0"> ) )</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">PassportNaiveTestController</span><span class="hl-0"> {</span><br/><span class="hl-0">    @</span><span class="hl-1">Get</span><span class="hl-0">()</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">method</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-3">// ...</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/>
</code></pre>
</details>


<a href="#the-tests" id="the-tests" style="color: inherit; text-decoration: none;">
  <h2>The tests</h2>
</a>
<p>Wanna see the behavior as tests ? Here you are !</p>
<details class="code-block"><summary><p>From ./test/demo/use-with-guards/naive-test.e2e-spec.ts</p></summary><pre><code class="language-ts"><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">HttpStatus</span><span class="hl-0">, </span><span class="hl-4">INestApplication</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/common&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">JwtModule</span><span class="hl-0">, </span><span class="hl-4">JwtService</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/jwt&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">Test</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@nestjs/testing&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> </span><span class="hl-4">request</span><span class="hl-0"> </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;supertest&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">CaslModule</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;@knodes/nest-casl&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">AbilityFactory</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;./ability-factory.service&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">JwtPassportStrategy</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;./jwt-passport.strategy&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">NaiveTestController</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;./naive.controller&#39;</span><span class="hl-0">;</span><br/><span class="hl-8">import</span><span class="hl-0"> { </span><span class="hl-4">PassportNaiveTestController</span><span class="hl-0"> } </span><span class="hl-8">from</span><span class="hl-0"> </span><span class="hl-6">&#39;./passport-naive.controller&#39;</span><span class="hl-0">;</span><br/><br/><span class="hl-1">describe</span><span class="hl-0">( </span><span class="hl-6">&#39;Use with guards (naive)&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-2">let</span><span class="hl-0"> </span><span class="hl-4">app</span><span class="hl-0">: </span><span class="hl-5">INestApplication</span><span class="hl-0">;</span><br/><br/><span class="hl-0">    </span><span class="hl-1">describe</span><span class="hl-0">( </span><span class="hl-6">&#39;NaiveTestController&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-1">beforeAll</span><span class="hl-0">( </span><span class="hl-2">async</span><span class="hl-0"> () </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">moduleRef</span><span class="hl-0"> = </span><span class="hl-8">await</span><span class="hl-0"> </span><span class="hl-4">Test</span><span class="hl-0">.</span><span class="hl-1">createTestingModule</span><span class="hl-0">( {</span><br/><span class="hl-0">                </span><span class="hl-4">imports:</span><span class="hl-0"> [</span><br/><span class="hl-0">                    </span><span class="hl-4">CaslModule</span><span class="hl-0">.</span><span class="hl-1">withConfig</span><span class="hl-0">( ( { </span><span class="hl-4">abilityFactory:</span><span class="hl-0"> </span><span class="hl-4">AbilityFactory</span><span class="hl-0"> } ) ),</span><br/><span class="hl-0">                ],</span><br/><span class="hl-0">                </span><span class="hl-4">controllers:</span><span class="hl-0"> [ </span><span class="hl-4">NaiveTestController</span><span class="hl-0"> ],</span><br/><span class="hl-0">            } ).</span><span class="hl-1">compile</span><span class="hl-0">();</span><br/><br/><span class="hl-0">            </span><span class="hl-4">app</span><span class="hl-0"> = </span><span class="hl-4">moduleRef</span><span class="hl-0">.</span><span class="hl-1">createNestApplication</span><span class="hl-0">();</span><br/><span class="hl-0">            </span><span class="hl-8">await</span><span class="hl-0"> </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">init</span><span class="hl-0">();</span><br/><span class="hl-0">        } );</span><br/><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should send an UNAUTHORIZED error if no authorization set&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">UNAUTHORIZED</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( { </span><span class="hl-4">statusCode:</span><span class="hl-0"> </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">UNAUTHORIZED</span><span class="hl-0">, </span><span class="hl-4">message:</span><span class="hl-0"> </span><span class="hl-6">&#39;Missing authorization header&#39;</span><span class="hl-0">, </span><span class="hl-4">error:</span><span class="hl-0"> </span><span class="hl-6">&#39;Unauthorized&#39;</span><span class="hl-0"> } ) );</span><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should send a FORBIDDEN error if invalid authorization&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">set</span><span class="hl-0">( </span><span class="hl-6">&#39;Authorization&#39;</span><span class="hl-0">, </span><span class="hl-6">&#39;invalid&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">FORBIDDEN</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( { </span><span class="hl-4">statusCode:</span><span class="hl-0"> </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">FORBIDDEN</span><span class="hl-0">, </span><span class="hl-4">message:</span><span class="hl-0"> </span><span class="hl-6">&#39;Forbidden resource&#39;</span><span class="hl-0">, </span><span class="hl-4">error:</span><span class="hl-0"> </span><span class="hl-6">&#39;Forbidden&#39;</span><span class="hl-0"> } ) );</span><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should send a FORBIDDEN error if invalid capabilities&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">set</span><span class="hl-0">( </span><span class="hl-6">&#39;Authorization&#39;</span><span class="hl-0">, </span><span class="hl-6">&#39;user&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">FORBIDDEN</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( { </span><span class="hl-4">statusCode:</span><span class="hl-0"> </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">FORBIDDEN</span><span class="hl-0">, </span><span class="hl-4">message:</span><span class="hl-0"> </span><span class="hl-6">&#39;Invalid authorizations: Can</span><span class="hl-9">\\</span><span class="hl-6">&#39;</span><span class="hl-4">t</span><span class="hl-0"> </span><span class="hl-6">&quot;admin&quot;</span><span class="hl-0"> </span><span class="hl-4">on</span><span class="hl-0"> </span><span class="hl-6">&quot;something&quot;&#39;, error: &#39;</span><span class="hl-4">Forbidden</span><span class="hl-6">&#39; } ) )</span><span class="hl-10">;</span><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should work&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">set</span><span class="hl-0">( </span><span class="hl-6">&#39;Authorization&#39;</span><span class="hl-0">, </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">OK</span><span class="hl-0"> ) );</span><br/><span class="hl-0">    } );</span><br/><span class="hl-0">    </span><span class="hl-1">describe</span><span class="hl-0">( </span><span class="hl-6">&#39;PassportNaiveTestController&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-1">beforeAll</span><span class="hl-0">( </span><span class="hl-2">async</span><span class="hl-0"> () </span><span class="hl-2">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">            </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">moduleRef</span><span class="hl-0"> = </span><span class="hl-8">await</span><span class="hl-0"> </span><span class="hl-4">Test</span><span class="hl-0">.</span><span class="hl-1">createTestingModule</span><span class="hl-0">( {</span><br/><span class="hl-0">                </span><span class="hl-4">imports:</span><span class="hl-0"> [</span><br/><span class="hl-0">                    </span><span class="hl-4">CaslModule</span><span class="hl-0">.</span><span class="hl-1">withConfig</span><span class="hl-0">( ( { </span><span class="hl-4">abilityFactory:</span><span class="hl-0"> </span><span class="hl-4">AbilityFactory</span><span class="hl-0"> } ) ),</span><br/><span class="hl-0">                    </span><span class="hl-4">JwtModule</span><span class="hl-0">.</span><span class="hl-1">register</span><span class="hl-0">( { </span><span class="hl-4">secret:</span><span class="hl-0"> </span><span class="hl-4">JwtPassportStrategy</span><span class="hl-0">.</span><span class="hl-7">KEY</span><span class="hl-0"> } ),</span><br/><span class="hl-0">                ],</span><br/><span class="hl-0">                </span><span class="hl-4">providers:</span><span class="hl-0"> [ </span><span class="hl-4">JwtPassportStrategy</span><span class="hl-0"> ],</span><br/><span class="hl-0">                </span><span class="hl-4">controllers:</span><span class="hl-0"> [ </span><span class="hl-4">PassportNaiveTestController</span><span class="hl-0"> ],</span><br/><span class="hl-0">            } ).</span><span class="hl-1">compile</span><span class="hl-0">();</span><br/><br/><span class="hl-0">            </span><span class="hl-4">app</span><span class="hl-0"> = </span><span class="hl-4">moduleRef</span><span class="hl-0">.</span><span class="hl-1">createNestApplication</span><span class="hl-0">();</span><br/><span class="hl-0">            </span><span class="hl-8">await</span><span class="hl-0"> </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">init</span><span class="hl-0">();</span><br/><span class="hl-0">        } );</span><br/><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should send an UNAUTHORIZED error if no authorization set&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/passport/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">UNAUTHORIZED</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">expect</span><span class="hl-0">( { </span><span class="hl-4">statusCode:</span><span class="hl-0"> </span><span class="hl-4">HttpStatus</span><span class="hl-0">.</span><span class="hl-7">UNAUTHORIZED</span><span class="hl-0">, </span><span class="hl-4">message:</span><span class="hl-0"> </span><span class="hl-6">&#39;Unauthorized&#39;</span><span class="hl-0"> } ) );</span><br/><span class="hl-0">        </span><span class="hl-1">it</span><span class="hl-0">( </span><span class="hl-6">&#39;should send a FORBIDDEN error if invalid capabilities&#39;</span><span class="hl-0">, () </span><span class="hl-2">=&gt;</span><span class="hl-0"> </span><span class="hl-1">request</span><span class="hl-0">( </span><span class="hl-4">app</span><span class="hl-0">.</span><span class="hl-1">getHttpServer</span><span class="hl-0">() )</span><br/><span class="hl-0">            .</span><span class="hl-1">get</span><span class="hl-0">( </span><span class="hl-6">&#39;/passport/naive&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">            .</span><span class="hl-1">set</span><span class="hl-0">( </span><span class="hl-6">&#39;Authorization&#39;</span><span class="hl-0">, \</span><span class="hl-6">`Bearer </span><span class="hl-2">${</span><span class="hl-4">app</span><span class="hl-11">.</span><span class="hl-1">get</span><span class="hl-11">( </span><span class="hl-4">JwtService</span><span class="hl-11"> ).</span><span class="hl-1">sign</span><span class="hl-11">( { </span><span class="hl-4">role:</span><span class="hl-11"> </span><span class="hl-6">&#39;user&#39;</span><span class="hl-11"> } )</span><span class="hl-2">}</span><span class="hl-9">\`</span><span class="hl-6"> )</span><br/><span class="hl-6">            .expect( HttpStatus.FORBIDDEN )</span><br/><span class="hl-6">            .expect( { statusCode: HttpStatus.FORBIDDEN, message: &#39;Invalid authorizations: Can</span><span class="hl-9">\\</span><span class="hl-6">&#39;t &quot;admin&quot; on &quot;something&quot;&#39;, error: &#39;Forbidden&#39; } ) );</span><br/><span class="hl-6">        it( &#39;should work&#39;, () =&gt; request( app.getHttpServer() )</span><br/><span class="hl-6">            .get( &#39;/passport/naive&#39; )</span><br/><span class="hl-6">            .set( &#39;Authorization&#39;, </span><span class="hl-9">\`</span><span class="hl-6">Bearer </span><span class="hl-2">${</span><span class="hl-4">app</span><span class="hl-11">.</span><span class="hl-1">get</span><span class="hl-11">( </span><span class="hl-4">JwtService</span><span class="hl-11"> ).</span><span class="hl-1">sign</span><span class="hl-11">( { </span><span class="hl-4">role:</span><span class="hl-11"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-11"> } )</span><span class="hl-2">}</span><span class="hl-9">\`</span><span class="hl-6"> )</span><br/><span class="hl-6">            .expect( HttpStatus.OK ) );</span><br/><span class="hl-6">    } );</span><br/><span class="hl-6">} );</span><br/>
</code></pre>
</details>


<a href="#the-recommended-approach" id="the-recommended-approach" style="color: inherit; text-decoration: none;">
  <h1>The recommended approach</h1>
</a>
<p>What&#39;s the problem about the na誰ve approach above ? Well, there are 2.</p>
<ol>
<li><em>The readability</em>: The <code>UseGuards</code> decorator is placed <strong>below</strong> the <a href="../../modules.html#Policy"><code>Policy</code></a> decorator, but is ran <strong>before</strong> it.</li>
<li><em>The reusability</em>: If you&#39;re using multiple authentication strategies in the same app, you might have to apply guards <strong>and</strong> the policies on each method depending on the context. Moreover, if you want to type-check your policies, you might prefer to have abilities presets.</li>
</ol>

<a href="#about-readability" id="about-readability" style="color: inherit; text-decoration: none;">
  <h2>About readability</h2>
</a>
<p>You can use <a href="../../modules/Policy.html#usingGuard"><code>Policy.usingGuard</code></a> or <a href="../../modules/PoliciesMask.html#usingGuard"><code>PoliciesMask.usingGuard</code></a> to prepended guards to the decorator factory. Those calls are cumulative, and you can do multiple subsequent calls to join guards using an <code>and</code> condition. If you provide an array of guards, they be evaluated using an <code>or</code> condition.</p>
<details class="code-block" open><summary><p>From src/controllers/recommended.controller.ts</p></summary><pre><code class="language-ts"><span class="hl-0">@</span><span class="hl-1">Controller</span><span class="hl-0">( </span><span class="hl-6">&#39;/recommended&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">@</span><span class="hl-1">Policy</span><span class="hl-0">( { </span><span class="hl-4">action:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-4">subject:</span><span class="hl-0"> </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> } )</span><br/><span class="hl-0">    .</span><span class="hl-1">usingGuard</span><span class="hl-0">( </span><span class="hl-1">AuthGuard</span><span class="hl-0">( </span><span class="hl-6">&#39;jwt&#39;</span><span class="hl-0"> ) ) </span><span class="hl-3">// The policy will run the guard before doing its own checks.</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">RecommendedTestController</span><span class="hl-0"> {</span><br/><span class="hl-0">    @</span><span class="hl-1">Get</span><span class="hl-0">()</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">method</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-3">// ...</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span>
</code></pre>
</details>


<a href="#about-reusability" id="about-reusability" style="color: inherit; text-decoration: none;">
  <h2>About reusability</h2>
</a>
<p>You can even prepare a policy decorator with guards or <a href="../../modules.html#PolicyDescriptor"><code>PolicyDescriptor</code></a>:</p>
<details class="code-block" open><summary><p>From src/policies.ts</p></summary><pre><code class="language-ts"><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">AdminViaJwtPolicy</span><span class="hl-0"> = </span><span class="hl-1">Policy</span><span class="hl-0">( { </span><span class="hl-4">action:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-4">subject:</span><span class="hl-0"> </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> } )</span><br/><span class="hl-0">    .</span><span class="hl-1">usingGuard</span><span class="hl-0">( </span><span class="hl-1">AuthGuard</span><span class="hl-0">( </span><span class="hl-6">&#39;jwt&#39;</span><span class="hl-0"> ) );</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">const</span><span class="hl-0"> </span><span class="hl-7">ViaJwtPolicy</span><span class="hl-0"> = </span><span class="hl-4">Policy</span><span class="hl-0">.</span><span class="hl-1">usingGuard</span><span class="hl-0">( </span><span class="hl-1">AuthGuard</span><span class="hl-0">( </span><span class="hl-6">&#39;jwt&#39;</span><span class="hl-0"> ) );</span>
</code></pre>
</details>

<p>Then, use those presets in your controller:</p>
<details class="code-block" open><summary><p>From src/recommended-bound.controller.ts</p></summary><pre><code class="language-ts"><span class="hl-0">@</span><span class="hl-1">Injectable</span><span class="hl-0">()</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">ExtraGuard1</span><span class="hl-0"> </span><span class="hl-2">implements</span><span class="hl-0"> </span><span class="hl-5">CanActivate</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">canActivate</span><span class="hl-0">( </span><span class="hl-4">context</span><span class="hl-0">: </span><span class="hl-5">ExecutionContext</span><span class="hl-0"> ): </span><span class="hl-5">boolean</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-8">if</span><span class="hl-0">( !</span><span class="hl-4">context</span><span class="hl-0">.</span><span class="hl-1">switchToHttp</span><span class="hl-0">().</span><span class="hl-1">getRequest</span><span class="hl-0">().</span><span class="hl-4">user</span><span class="hl-0">.</span><span class="hl-4">allowed1</span><span class="hl-0"> ){</span><br/><span class="hl-0">            </span><span class="hl-8">throw</span><span class="hl-0"> </span><span class="hl-2">new</span><span class="hl-0"> </span><span class="hl-1">BadRequestException</span><span class="hl-0">( </span><span class="hl-6">&#39;Not allowed from ExtraGuard1&#39;</span><span class="hl-0"> );</span><br/><span class="hl-0">        }</span><br/><span class="hl-0">        </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-2">true</span><span class="hl-0">;</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/><span class="hl-0">@</span><span class="hl-1">Injectable</span><span class="hl-0">()</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">ExtraGuard2</span><span class="hl-0"> </span><span class="hl-2">implements</span><span class="hl-0"> </span><span class="hl-5">CanActivate</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">canActivate</span><span class="hl-0">( </span><span class="hl-4">context</span><span class="hl-0">: </span><span class="hl-5">ExecutionContext</span><span class="hl-0"> ): </span><span class="hl-5">boolean</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-8">return</span><span class="hl-0"> </span><span class="hl-4">context</span><span class="hl-0">.</span><span class="hl-1">switchToHttp</span><span class="hl-0">().</span><span class="hl-1">getRequest</span><span class="hl-0">().</span><span class="hl-4">user</span><span class="hl-0">.</span><span class="hl-4">allowed2</span><span class="hl-0"> ?? </span><span class="hl-2">false</span><span class="hl-0">;</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span><br/><br/><span class="hl-0">@</span><span class="hl-1">Controller</span><span class="hl-0">( </span><span class="hl-6">&#39;/recommended/bound&#39;</span><span class="hl-0"> )</span><br/><span class="hl-8">export</span><span class="hl-0"> </span><span class="hl-2">class</span><span class="hl-0"> </span><span class="hl-5">RecommendedBoundTestController</span><span class="hl-0"> {</span><br/><span class="hl-0">    @</span><span class="hl-1">Get</span><span class="hl-0">( </span><span class="hl-6">&#39;method1&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">    @</span><span class="hl-4">AdminViaJwtPolicy</span><br/><span class="hl-0">        .</span><span class="hl-1">usingGuard</span><span class="hl-0">( [ </span><span class="hl-4">ExtraGuard1</span><span class="hl-0">, </span><span class="hl-4">ExtraGuard2</span><span class="hl-0"> ] ) </span><span class="hl-3">// Add guards. When passed as an array, if either one can activate, it will continue</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">method1</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-3">// ...</span><br/><span class="hl-0">    }</span><br/><br/><span class="hl-0">    @</span><span class="hl-1">Get</span><span class="hl-0">( </span><span class="hl-6">&#39;method2&#39;</span><span class="hl-0"> )</span><br/><span class="hl-0">    @</span><span class="hl-1">ViaJwtPolicy</span><span class="hl-0">( { </span><span class="hl-4">action:</span><span class="hl-0"> </span><span class="hl-6">&#39;admin&#39;</span><span class="hl-0">, </span><span class="hl-4">subject:</span><span class="hl-0"> </span><span class="hl-6">&#39;something&#39;</span><span class="hl-0"> } )</span><br/><span class="hl-0">        .</span><span class="hl-1">usingGuard</span><span class="hl-0">( [ </span><span class="hl-4">ExtraGuard1</span><span class="hl-0">, </span><span class="hl-4">ExtraGuard2</span><span class="hl-0"> ] ) </span><span class="hl-3">// Add guards. When passed as an array, if either one can activate, it will continue</span><br/><span class="hl-0">    </span><span class="hl-2">public</span><span class="hl-0"> </span><span class="hl-1">method2</span><span class="hl-0">(){</span><br/><span class="hl-0">        </span><span class="hl-3">// ...</span><br/><span class="hl-0">    }</span><br/><span class="hl-0">}</span>
</code></pre>
</details>

<p>Now, both <code>method1</code> and <code>method2</code> will run if</p>
<ul>
<li>the user is authenticated through <code>jwt</code> strategy</li>
<li>it passes either <code>ExtraGuard1</code> or <code>ExtraGuard2</code></li>
<li>and he has admin role.</li>
</ul>
<blockquote>
<p>Note that you can use <a href="../../modules.html#bindPolicyDecorators"><code>bindPolicyDecorators</code></a> to bind <em>both</em> <a href="../../modules.html#Policy"><code>Policy</code></a> and <a href="../../modules.html#PoliciesMask"><code>PoliciesMask</code></a></p>
</blockquote>

<a href="#the-tests-1" id="the-tests-1" style="color: inherit; text-decoration: none;">
  <h2>The tests</h2>
</a>
<p>This is tested, of course. Just see by yourself.</p>
<p>{@codeblock folded use-with-guards/recommended-test.e2e-spec.ts}</p>

<a href="#what-next-" id="what-next-" style="color: inherit; text-decoration: none;">
  <h1>What next ?</h1>
</a>
<p><a href="better-type-constraints.html">Better type constraints</a></p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class=""><a href="../../modules.html">Exports</a></li><li class="current pages-entry pages-entry-menu pages-entry-depth-0"><a>Guides</a></li><li class=" pages-entry pages-entry-page pages-entry-depth-1"><a href="getting-started.html">Getting started</a></li><li class="current pages-entry pages-entry-page pages-entry-depth-1"><a href="use-with-guards.html">Use with guards</a></li><li class=" pages-entry pages-entry-page pages-entry-depth-1"><a href="better-type-constraints.html">Better type constraints</a></li><li class=" pages-entry pages-entry-page pages-entry-depth-0"><a href="../../CHANGELOG.html">Changelog</a></li><li class=" tsd-kind-namespace"><a href="../../modules/PoliciesMask.html">Policies<wbr/>Mask</a></li><li class=" tsd-kind-namespace"><a href="../../modules/Policy.html">Policy</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-method tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="../../assets/main.js"></script></body></html>